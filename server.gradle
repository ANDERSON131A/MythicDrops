task downloadBuildTools << {
    println "Downloading Spigot..."
    def spigotDownload = project.properties['downloads.spigot']

    def targetDir = new File(project.rootDir, 'server')
    if (!targetDir.exists()) {
        targetDir.mkdirs()
    }

    def targetFileName = 'BuildTools.jar'
    def targetFile = new File(targetDir, targetFileName)

    if (targetFile.exists()) {
        println 'BuildTools is already downloaded!'
        return
    }

    def targetFileStream = targetFile.newOutputStream()
    targetFileStream << new URL(sprintf('%s', [spigotDownload])).openStream()
    targetFileStream.close()
    println 'Spigot downloaded!'
}

task installSpigot << {
    println "Installing Spigot..."
    def targetDir = new File(project.rootDir, 'server')
    if (!targetDir.exists()) {
        println "Spigot is not downloaded!"
        return
    }

    def targetFileName = 'BuildTools.jar'
    def targetFile = new File(targetDir, targetFileName)
    if (!targetFile.exists()) {
        println "BuildTools is not downloaded!"
        return
    }

    def outputDir = "${targetDir}/Spigot"
    def outputFileName = 'spigot-1.10.2.jar'
    def outputFile = new File(outputDir, outputFileName)
    if (outputFile.exists()) {
        println "Spigot is already installed!"
        return
    }

    exec {
        workingDir targetDir
        commandLine './build.sh'
        standardOutput = new ByteArrayOutputStream()
    }
    copy {
        from outputFile
        into targetDir
    }
    println 'Spigot installed!'
}
installSpigot.dependsOn downloadBuildTools

task server << {
    println "Starting server..."

    def targetDir = new File(project.rootDir, 'server')

    if (!targetDir.exists()) {
        println "Spigot is not downloaded!"
        return
    }

    def targetFileName = 'spigot-1.10.2.jar'

    def memoryMin = project.properties['memory.min']
    def memoryMax = project.properties['memory.max']

    def memMin = sprintf('-Xms%s', [memoryMin])
    def memMax = sprintf('-Xmx%s', [memoryMax])
    javaexec {
        workingDir targetDir
        commandLine 'java', memMin, memMax, '-jar', targetFileName
        standardInput System.in
    }
}
server.dependsOn installSpigot